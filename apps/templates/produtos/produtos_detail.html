{% extends 'layouts/base.html' %}
{% block title %}Detalhe do Produto{% endblock %}
{% block conteudo %}
<div class="content">
    <div class="page-header">
        <h1>{{ produto.nome }}</h1>
        <a href="{% url 'produtos:produtos_edit' produto.id %}" class="btn btn-edit">Editar</a>
        <a href="{% url 'produtos:produtos_list' %}" class="btn btn-secondary">Voltar</a>
    </div>
    <div class="detail-card">
        <div class="detail-content">
            <div class="detail-info">
                <div class="detail-row"><span class="detail-label">Categoria:</span> {{ produto.categoria }}</div>
                <div class="detail-row"><span class="detail-label">Marca:</span> {{ produto.marca }}</div>
                <div class="detail-row"><span class="detail-label">Fornecedor:</span> {{ produto.fornecedor }}</div>
                <div class="detail-row"><span class="detail-label">Status:</span>
                    {% if produto.status %}<span class="badge badge-success">Ativo</span>
                    {% else %}<span class="badge badge-danger">Inativo</span>
                    {% endif %}
                </div>
                <div class="detail-row"><span class="detail-label">Estoque:</span>
                    {% for v in produto.variacoes.all %}
                        {{ v.tamanho|default:"-" }}: {{ v.quantidade|floatformat:2 }} {{ v.unidade }}<br>
                    {% empty %}
                        <span>-</span>
                    {% endfor %}
                </div>
                <div class="detail-row"><span class="detail-label">Preço custo:</span> R$ {{ produto.preco_custo|floatformat:2 }}</div>
                <div class="detail-row"><span class="detail-label">Preço venda:</span> R$ {{ produto.preco_venda|floatformat:2 }}</div>
                <div class="detail-row"><span class="detail-label">Descrição:</span> {{ produto.descricao|default:"-" }}</div>
                <div class="detail-row">
                    <span class="detail-label">Campos Personalizados:</span>
                    {% for valor in produto.valores_campos.all %}
                        <strong>{{ valor.campo.nome }}:</strong> {{ valor.valor }}<br>
                    {% empty %}Nenhum campo dinâmico cadastrado.<br>{% endfor %}
                </div>
            </div>
            <div class="detail-image">
                {% if produto.imagem %}
                    <img src="{{ produto.imagem.url }}" class="product-image" alt="{{ produto.nome }}">
                {% else %}
                    <div class="no-image">Sem imagem</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="detail-card">
        <h2>Variações e Lotes</h2>
        {% for v in produto.variacoes.all %}
        <div class="mb-2">
            <b>{{ v.tamanho|default:"-" }} / {{ v.unidade }}</b> - Estoque: {{ v.quantidade|floatformat:2 }}
            <table class="table" style="margin-bottom:0.5rem;">
                <thead>
                    <tr>
                        <th>Lote</th>
                        <th>Qtd</th>
                        <th>Preço</th>
                        <th>Data Entrada</th>
                        <th>Nota Fiscal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lote in v.lotes.all %}
                    <tr>
                        <td>{{ lote.numero_lote }}</td>
                        <td>{{ lote.quantidade|floatformat:2 }}</td>
                        <td>
                            {% if lote.preco_unitario %}R$ {{ lote.preco_unitario|floatformat:2 }}
                            {% else %}-{% endif %}
                        </td>
                        <td>{{ lote.data_entrada|date:"d/m/Y H:i" }}</td>
                        <td>
                            {% if lote.documento_nfe %}
                                <a href="{{ lote.documento_nfe.url }}" target="_blank">Ver XML</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5"><i>Sem lotes cadastrados para essa variação.</i></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% empty %}
        <div><i>Sem variações cadastradas para esse produto.</i></div>
        {% endfor %}
    </div>
    <div class="detail-card">
        <h2>Histórico de Movimentações</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Variação</th>
                    <th>Quantidade</th>
                    <th>Lote</th>
                    <th>Usuário</th>
                    <th>Obs</th>
                </tr>
            </thead>
            <tbody>
                {% for m in produto.variacoes.all|map:"movimentacoes.all"|sum %}
                <tr>
                    <td>{{ m.data|date:"d/m/Y H:i" }}</td>
                    <td>{{ m.tipo.nome }}</td>
                    <td>{{ m.variacao.tamanho }}</td>
                    <td>{{ m.quantidade }}</td>
                    <td>{% if m.lote %}{{ m.lote.numero_lote }}{% endif %}</td>
                    <td>{{ m.usuario }}</td>
                    <td>{{ m.observacao }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="7">Nenhuma movimentação registrada para este produto.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
